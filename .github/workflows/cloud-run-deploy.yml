name: Deploy to Cloud Run

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ vars.GCP_REGION || 'us-central1' }}
  REPO: ${{ vars.ARTIFACT_REPO || 'agenttown' }}
  WEB_SERVICE: ${{ vars.CLOUD_RUN_WEB_SERVICE || 'agenttown-web' }}
  WS_SERVICE: ${{ vars.CLOUD_RUN_WS_SERVICE || 'agenttown-ws' }}
  CLOUD_RUN_RUNTIME_SERVICE_ACCOUNT: ${{ vars.CLOUD_RUN_RUNTIME_SERVICE_ACCOUNT || '' }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required GitHub Secrets
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
        run: |
          set -euo pipefail
          missing=()
          [[ -z "${PROJECT_ID}" ]] && missing+=("GCP_PROJECT_ID")
          [[ -z "${WORKLOAD_IDENTITY_PROVIDER}" ]] && missing+=("GCP_WORKLOAD_IDENTITY_PROVIDER")
          [[ -z "${SERVICE_ACCOUNT}" ]] && missing+=("GCP_SERVICE_ACCOUNT")
          if [[ ${#missing[@]} -gt 0 ]]; then
            echo "::error::Missing required GitHub Secrets: ${missing[*]}"
            exit 1
          fi

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Validate bootstrap resources
        run: |
          set -euo pipefail
          if ! gcloud artifacts repositories describe "${REPO}" --location "${REGION}" >/dev/null 2>&1; then
            echo "::error::Artifact Registry repository '${REPO}' was not found in '${REGION}'. Run infra Terraform bootstrap first."
            exit 1
          fi

      - name: Build Cloud Run secret mappings
        run: |
          set -euo pipefail
          SECRET_MAPPINGS="$(./scripts/gcp/render-cloud-run-secrets.sh --keys-file scripts/gcp/cloud-run-env.keys)"
          echo "CLOUD_RUN_SECRET_MAPPINGS=${SECRET_MAPPINGS}" >> "${GITHUB_ENV}"

      - name: Load build-time public env from Secret Manager
        run: |
          set -euo pipefail
          NEXT_PUBLIC_AI_ENABLED="$(gcloud secrets versions access latest --secret NEXT_PUBLIC_AI_ENABLED)"
          NEXT_PUBLIC_SIM_LOG_LEVEL="$(gcloud secrets versions access latest --secret NEXT_PUBLIC_SIM_LOG_LEVEL)"
          {
            echo "NEXT_PUBLIC_AI_ENABLED<<EOF"
            echo "${NEXT_PUBLIC_AI_ENABLED}"
            echo "EOF"
            echo "NEXT_PUBLIC_SIM_LOG_LEVEL<<EOF"
            echo "${NEXT_PUBLIC_SIM_LOG_LEVEL}"
            echo "EOF"
          } >> "${GITHUB_ENV}"

      - name: Configure Docker
        run: gcloud auth configure-docker ${REGION}-docker.pkg.dev -q

      - name: Build and push WebSocket image
        run: |
          WS_IMAGE="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/agenttown-ws:${GITHUB_SHA}"
          docker build -f Dockerfile.ws -t "${WS_IMAGE}" .
          docker push "${WS_IMAGE}"
          echo "WS_IMAGE=${WS_IMAGE}" >> "${GITHUB_ENV}"

      - name: Deploy WebSocket service
        run: |
          set -euo pipefail
          SA_ARGS=()
          if [[ -n "${CLOUD_RUN_RUNTIME_SERVICE_ACCOUNT}" ]]; then
            SA_ARGS+=(--service-account "${CLOUD_RUN_RUNTIME_SERVICE_ACCOUNT}")
          fi
          gcloud run deploy "${WS_SERVICE}" \
            --image "${WS_IMAGE}" \
            --region "${REGION}" \
            --allow-unauthenticated \
            "${SA_ARGS[@]}" \
            --clear-env-vars \
            --set-secrets "${CLOUD_RUN_SECRET_MAPPINGS}"

      - name: Resolve WebSocket URL
        id: ws_url
        run: |
          WS_URL=$(gcloud run services describe "${WS_SERVICE}" --region "${REGION}" --format='value(status.url)')
          WSS_URL="${WS_URL/https:/wss:}"
          echo "wss_url=${WSS_URL}" >> "${GITHUB_OUTPUT}"

      - name: Build and push Web image
        run: |
          WEB_IMAGE="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/agenttown-web:${GITHUB_SHA}"
          docker build -f Dockerfile \
            --build-arg NEXT_PUBLIC_AI_ENABLED="${NEXT_PUBLIC_AI_ENABLED}" \
            --build-arg NEXT_PUBLIC_SIM_LOG_LEVEL="${NEXT_PUBLIC_SIM_LOG_LEVEL}" \
            --build-arg NEXT_PUBLIC_WS_URL="${{ steps.ws_url.outputs.wss_url }}" \
            -t "${WEB_IMAGE}" .
          docker push "${WEB_IMAGE}"
          echo "WEB_IMAGE=${WEB_IMAGE}" >> "${GITHUB_ENV}"

      - name: Deploy Web service
        run: |
          set -euo pipefail
          SA_ARGS=()
          if [[ -n "${CLOUD_RUN_RUNTIME_SERVICE_ACCOUNT}" ]]; then
            SA_ARGS+=(--service-account "${CLOUD_RUN_RUNTIME_SERVICE_ACCOUNT}")
          fi
          gcloud run deploy "${WEB_SERVICE}" \
            --image "${WEB_IMAGE}" \
            --region "${REGION}" \
            --allow-unauthenticated \
            "${SA_ARGS[@]}" \
            --clear-env-vars \
            --set-secrets "${CLOUD_RUN_SECRET_MAPPINGS}"
