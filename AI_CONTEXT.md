# AgentTown 仕様書

## 概要
AgentTown は、災害対応やイベント運営の「予行演習」をブラウザで体験できる 2.5D シミュレーションです。災害時は公式情報の遅延や状況の曖昧さが噂の拡散を招きやすいという前提（重要性 × 曖昧さ）を踏まえ、仮想住民は噂・公式情報・周囲の行動を手掛かりに自律的に動き、情報伝播や避難判断の分岐を観察できます。目的は **創発的な集団行動** と **脆弱層の取り残されやすさ** を可視化することです。

## 設計背景（社会学的知見）
- 公式情報の遅延と曖昧さが強いほど、噂や誤情報が増幅しやすい。
- 誤情報はパニック誘発、支援リソースの誤配分、公的機関への不信につながる。
- 情報取得に障壁のある住民（高齢者、要介助、非日本語話者、独居など）が不釣り合いに影響を受けやすい。
- AI 生成や海外発の偽情報が災害時に紛れ込みやすく、検証の遅れが被害を拡大する。
- 介入カード（公式警報一斉配信 / ファクトチェック / 要支援者支援 など）の効果を比較しやすい設計とする。

## ゴール / 非ゴール
### ゴール
- アイソメ視点の街（OrthographicCamera）を描画
- 道路/草地タイルを InstancedMesh で表示
- 住民（設定に応じた人数）が滑らかに移動し、噂・公式情報・避難行動がタイムラインに流れる
- HTML UI でメトリクス / タイムライン / 介入パネルを表示
- シミュレーションは安定化 / 危機拡大 / タイムアップで終了し、結果モーダルを表示
- 建物・住民にホバーすると吹き出し、クリックで固定表示（最大1つ）
- WebSocket サーバーで WORLD_INIT / WORLD_DIFF / EVENT / METRICS を配信
- サーバーがシミュレーションを進行し、クライアントは描画に専念
- 公式情報遅延と曖昧さに応じた噂拡散モデルを持ち、介入による収束性を比較できる
- 脆弱層の到達率・避難遅延・誤情報影響の差分を可視化する

### 非ゴール
- 本番の物理シミュレーションや群衆最適化
- 高精度な 3D モデル / アニメーション

## UI 構成（/sim）
- **TopHud**: 稼働状況、ティック、メトリクス（混乱度 / 噂拡散 / 公式到達 / 要支援到達 / 信頼度 / パニック）
- **LeftTimeline**: 事件ログ（警報 / 公式 / 噂 / 避難 / 支援 / 安否 / 移動 / 会話 / 介入）
- **BottomInterventions**: 介入カード（災害シナリオごとに内容が変化）
- **中央Canvas**: 3D街 + 住民 + クリック/ホバー用ツールチップ
- **起動モーダル**: 初期表示でサイズ/人数/建物/地形/災害シナリオを設定し、Start で開始
- **起動モーダル**: 住民の気分（温かめ/中立/冷ため）と年齢層（若年/バランス/高齢）も選択可能
- **起動モーダル**: 公式情報遅延、曖昧さ、デマ強度、多言語対応率、検証速度の初期パラメータを設定可能
- **結果モーダル**: 終了時にメトリクス推移と分布を可視化

## エージェント設計
- 基本属性: 年齢層、移動制約、言語、聴覚、世帯、役割
- 脆弱性タグ: 高齢者 / 子ども / 養育者 / 要介助 / 移動制約 / 聴覚障害 / 非日本語話者 / 独居 / デジタル弱者 など
- 状態: 気分、ストレス、エネルギー、警報認知（噂/公式/未達）、避難状態、信頼度、パニック度
- 起動モーダルの「住民の気分」「年齢層」によって初期ムード分布、ストレス、信頼度、噂感受性が変わる
- 非日本語話者は言語一致の情報のみ高い理解率を持つ。翻訳遅延がある場合は理解が遅れる
- 介助が必要な住民は単独では避難できず、支援が到達すると移動開始する

## 情報伝達モデル
- 情報は「公式」「噂」「目撃」「AI生成偽情報」「訂正/ファクトチェック」の種別を持つ
- 情報アイテムは重要度、曖昧さ、信頼度、言語、発生源、減衰率を持つ
- 噂拡散の発生率は `重要度 × 曖昧さ` を基本とし、個人のストレスと信頼度で増減する
- 公式情報の遅延中は不確実性が高まり、噂生成と拡散が加速する
- 拡散チャネルは対面、地域コミュニティ、SNS、公式放送、掲示/ピクトグラムに分かれる
- ファクトチェックが届くと、噂信念は減衰し、公式信頼度が一定値回復する
- 公式情報が繰り返し外れると信頼度が低下し、遵守率と共有率に影響する

## 影響モデル
- パニックは誤情報の強度、近傍の行動、災害の視認度で増減する
- 誤情報により誤った避難や支援要請が増えると、リソース誤配分が発生する
- 公的機関への不信が高い集団では、正しい避難誘導でも従わない割合が増える

## メトリクス
- 混乱度、噂拡散率、公式到達率、要支援到達率
- パニック指数、公式信頼度、誤情報信念率
- 要配慮者の避難遅延（平均/中央値）と到達率
- 誤避難・不要移動の発生件数、支援リソース誤配分率

## 3D表現
- OrthographicCamera のアイソメ視点
- 建物は箱の組み合わせで可愛く表現
- 住民は Sprite で表示、tick ごとに lerp 移動
- 車両は道路上にランダム配置し、ゆっくり巡回移動（見た目のみ）
- 地形は草地/海/山/公園タイルで色分け
- 住民の吹き出しは気分/役割/避難状態/イベント種別を組み合わせた文で生成し、同じ出来事でも個別に差が出る
- 吹き出しは個体ごとに0〜5秒の開始ずれを持ち、10秒単位で表示/非表示が切り替わる
- 同じ住民の吹き出しが連続して表示されないよう、5秒表示ごとに一度オフになる
- 吹き出し表示は全住民の約3%のみ（ウィンドウごとの疑似乱数で抽選）、同時表示は最大5つまで

## シナリオ例
- 沿岸の町、夕刻。地震発生。公式警報は15分遅延。
- 噂や誤情報が先行し、地区ごとに避難判断が分岐。ファクトチェック介入で収束性を比較。
- 観光地での地震。多言語対応が不足し、非日本語話者の避難開始が遅れる。
- 台風接近時に SNS で AI 生成の誤った避難先が拡散し、リソース誤配分が起きる。

## 操作
- 住民 / 建物にホバーで吹き出し表示
- クリックで吹き出し固定、別の対象をクリックで上書き
- 空白クリックで吹き出し解除

## AI 連携（将来/実装中）
- Vertex AI で住民の意思決定理由を生成
- Cloud SQL（MySQL）に reasoning を保存
- Terraform / scripts で GCP リソースとシードを準備
- 記憶生成 → Embedding → Vector Search upsert のパイプラインを用意
- Embedding が 429/RESOURCE_EXHAUSTED の場合は一定時間スキップしてシミュレーションを継続（`VERTEX_EMBED_COOLDOWN_MS`で調整）
- サーバー側で AI が行動決定するモードを用意（SIM_AI_DECISION_ENABLED）
- ADK（Agent Development Kit）経由の行動決定を用意（SIM_ADK_ENABLED）
- AI 行動決定が有効でも停滞を避けるため、住民は低頻度のアンビエント移動を行う
- AI 行動決定プロンプトに災害タイプ別の感情/会話トピック/行動ヒントと近隣会話ログを渡し、住民同士のやり取りを促進する
- AI 行動決定プロンプトに「住民の気分」「年齢層」も渡し、発話や行動のトーンを調整する
- SIM_END 時に Vector Search から類似イベント/噂汚染度の集計を取得し、結果画面に表示する
- 住民の行動は「記憶 → 内省 → 計画 → 行動」のサイクルで決定し、内省/計画はエージェントの状態に保持される
- 住民は食事/通勤/買い物/仕事/学校/旅行/遊び/休憩などの活動状態を持ち、タイムラインに生活イベントが記録される
- AI エージェントは全体の一部（デフォルト10%）のみ有効化し、残りはルールベースで行動する（SIM_AI_AGENT_RATIO）

## ゲーム要素
- 安定度スコアを導入し、混乱度・パニック・誤情報信念・要配慮者到達率で総合評価する
- 介入カードにはコストとクールダウンを設定し、予算内での最適化を楽しめる
- 難易度は「公式遅延」「曖昧さ」「デマ強度」「多言語対応率」「支援キャパ」で調整する
- 目標は「安定度閾値の達成」「要配慮者到達率の下限確保」「誤配分率の上限制約」など
- サンドボックスとチャレンジの2モードを用意し、調整と検証の両方を可能にする

## 論文抜粋対応チェック（要求トレース）
- 公式情報遅延と曖昧さで噂が拡散しやすい: 情報伝達モデル / ゴール / メトリクス
- デマがパニック・誤配分・不信を生む: 影響モデル / メトリクス
- AI 生成を含む偽情報の混入: 設計背景 / 情報伝達モデル / シナリオ例
- 高齢者・要介助・養育者・非日本語話者などの脆弱層: エージェント設計 / メトリクス
- 多言語対応不足の影響: エージェント設計 / シナリオ例 / UI 起動モーダル
- 介入の比較可能性: ゴール / 介入カード / ゲーム要素
